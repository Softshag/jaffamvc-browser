/*!
 * JaffaMVC.js 0.1.0
 * (c) 2015 Rasmus KildevÃ¦ld, Softshag.
 * Inspired and based on Backbone.Marionette.js
 * (c) 2014 Derick Bailey, Muted Solutions, LLC.
 * (c) 2014 Adam Krebs, Jimmy Yuen Ho Wong
 * JaffaMVC may be freely distributed under the MIT license.
 */
!function(t,e){if("function"==typeof define&&define.amd)define(["backbone","co"],e);else if("object"==typeof exports){var i,n=null,r=null;try{n=require("exoskeleton")}catch(o){try{n=require("backbone")}catch(o){i=o}}try{r=require("co")}catch(o){}if(null===n)throw i;module.exports=e(n,r)}else t.JaffaMVC=e(t.Exoskeleton||t.Backbone,r)}(this,function(t,e){"use strict";function i(){return o.Debug===!0?"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments):void 0}function n(){var t=void 0===arguments[0]?{}:arguments[0];if(!t.selector)throw new Error("No selector specified",t);return r(t.selector,t.regionClass||C)}function r(t,e){var i=o.$(t);if(!i.length)throw new Error("Selector must exists in the dom");return new e({el:i[0]})}var o={};o.version="0.1.0",o.Debug=!1;var s=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t)){for(var i,n=[],r=t[Symbol.iterator]();!(i=r.next()).done&&(n.push(i.value),!e||n.length!==e););return n}throw new TypeError("Invalid attempt to destructure non-iterable instance")},h=function(){function t(t,e){for(var i in e){var n=e[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(t,e)}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),u=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(t.__proto__=e)},a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};Object.assign(o,{Events:t.Events,History:t.History,Model:t.Model,Collection:t.Collection,Router:t.Router});var c=function(t){function e(){a(this,e),null!=t&&t.apply(this,arguments)}return u(e,t),e}(Error),l=function(t){function e(){a(this,e),null!=t&&t.apply(this,arguments)}return u(e,t),e}(c),d=function(t){var e=[],i=void 0,n=document,r=n.documentElement.doScroll,o="DOMContentLoaded",s=(r?/^loaded|^c/:/^loaded|^i|^c/).test(n.readyState);return s||n.addEventListener(o,i=function(){for(n.removeEventListener(o,i),s=1;i=e.shift();)i()}),function(t){s?t():e.push(t)}}();o.$=function(t,e){if("function"==typeof t)return d(t);if(e=e||document,"string"!=typeof t&&"nodeType"in t)return[t];if("string"==typeof e){if(e=document.querySelectorAll(e),!e.length)return e;var i=e,n=s(i,1);e=n[0]}return e.querySelectorAll(t)};var f=function(t){return t.toLowerCase().replace(/-(.)/g,function(t,e){return e.toUpperCase()})},p=Array.prototype.slice,g=Object.prototype.hasOwnProperty,y={callFunction:function(t,e,i){switch(i.length){case 0:return t.call(e);case 1:return t.call(e,i[0]);case 2:return t.call(e,i[0],i[1]);case 3:return t.call(e,i[0],i[1],i[2]);case 4:return t.call(e,i[0],i[1],i[2],i[3]);default:return t.apply(e,i)}},callAsyncFunction:function(t,i,n){return new Promise(function(r,o){var s=void 0,h=void 0;if(s=function(t,e){return t?o(t):void r(e)},t.length>1)return t.call(i,n,s);if(y.isGenerator(t)||y.isGeneratorFunction(t)){if(!e||"function"!=typeof e.wrap)throw new Error("generators support needs co! - see https://github.com/tj/co");t=e.wrap(t)}try{h=t.call(i,n)}catch(u){h=u}h instanceof Error?o(h):h&&y.isPromise(h)?h.then(r,o):r(h)})},eachAsync:function(t,e,i){var n=0,r=t.length;return new Promise(function(o,s){var h=function(t){var e=function(e){return t.apply(this,arguments)};return e.toString=function(){return t.toString()},e}(function(u){return null!=u||n===r?u?s(u):o():void y.callAsyncFunction(e,i,t[n++]).then(function(t){h()},h)});h(null)})},bindAll:function(t,e){return y.proxy(t,t,e)},getOption:function(t){var e=void 0===arguments[1]?{}:arguments[1],i=this.options||{};return e[t]||i[t]||this[t]},triggerMethod:function(t){var e=f("on-"+t.replace(/:/g,"-")),i=y.getOption.call(this,e),n=p.call(arguments,1);y.callFunction(this.trigger,this,p.call(arguments)),"function"==typeof i&&y.callFunction(i,this,n)},triggerMethodOn:function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),n=1;e>n;n++)i[n-1]=arguments[n];y.callFunction(y.triggerMethod,t,i)},proxy:function(t,e,i){Array.isArray(i)||(i=[i]),i.forEach(function(i){"function"==typeof e[i]&&(t[i]=e[i].bind(e))})},isGenerator:function(t){return"function"==typeof t.next&&"function"==typeof t["throw"]},isGeneratorFunction:function(t){var e=t.constructor;return e?"GeneratorFunction"===e.name||"GeneratorFunction"===e.displayName?!0:y.isGenerator(e.prototype):!1},isPromise:function(t){return"function"==typeof t.then},isObject:function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},result:function(t,e){for(var i=arguments.length,n=Array(i>2?i-2:0),r=2;i>r;r++)n[r-2]=arguments[r];return"function"==typeof t[e]?t[e].apply(t,n):t[e]}},m=function(){var t=function(){var t=void 0;if(null!=window.XMLHttpRequest)return new XMLHttpRequest;try{return new ActiveXObject("msxml2.xmlhttp.6.0")}catch(e){t=e}try{return new ActiveXObject("msxml2.xmlhttp.3.0")}catch(e){t=e}try{return new ActiveXObject("msxml2.xmlhttp")}catch(e){t=e}return t},e=/^(?:application|text)\/xml/,i=/^application\/json/,n=function(t,n){return null==t&&(t=n.getResponseHeader("content-type")),e.test(t)?n.responseXML:i.test(t)&&""!==n.responseText?JSON.parse(n.responseText):n.responseText},r=function(t){return t.status>=200&&t.status<300||304===t.status||0===t.status&&"file:"===window.location.protocol},o=function(t,e,i,o){return function(){if(4===t.readyState){var s=t.status,h=n(e.headers&&e.headers.Accept,t);if(r(t))e.success&&e.success(h),i&&i(h);else{var u=new Error("Server responded with a status of "+s);e.error&&e.error(t,s,u),o&&o(t)}}}};return function(e){if(null==e||!y.isObject(e))throw new Error("no opts");e.type=(e.type||"GET").toUpperCase();var i=t();if(i instanceof Error)throw i;var n=void 0,r=void 0,s=new Promise(function(t,e){n=t,r=e});if(null==e.headers&&(e.headers={}),e.headers["X-Requested-With"]="XMLHttpRequest",e.contentType&&(e.headers["Content-Type"]=e.contentType),"GET"===e.type&&"object"==typeof e.data){var h="",u=function(t,e){return null==e?"":"&"+encodeURIComponent(t)+"="+encodeURIComponent(e)};for(var a in e.data)h+=u(a,e.data[a]);if(h){var c=-1===e.url.indexOf("?")?"?":"&";e.url+=c+h.substring(1)}}i.addEventListener("readystatechange",o(i,e,n,r)),"function"==typeof e.progress&&i.addEventListener("progress",e.progress),i.open(e.type,e.url,!0);var l="*/".concat("*"),d={"*":l,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"};if(i.setRequestHeader("Accept",e.dataType&&d[e.dataType]?d[e.dataType]+("*"!==e.dataType?", "+l+"; q=0.01":""):d["*"]),e.headers)for(var f in e.headers)i.setRequestHeader(f,e.headers[f]);return e.beforeSend&&e.beforeSend(i),e.withCredentials&&(i.withCredentials=!0),i.send(e.data),s}},v=function(){function t(){a(this,t),"function"==typeof this.initialize&&y.callFunction(this.initialize,this,arguments)}return t.prototype.destroy=function(){for(var t=arguments.length,e=Array(t),i=0;t>i;i++)e[i]=arguments[i];if(!this.isDestroyed)return this.triggerMethod("before:destroy",e),this._isDestroyed=!0,this.triggerMethod("destroy",e),this.stopListening(),this},h(t,{isDestroyed:{get:function(){return null==this._isDestroyed&&(this._isDestroyed=!1),this._isDestroyed}}}),t}();v.extend=t.extend,Object.assign(v.prototype,t.Events,{getOption:y.getOption,triggerMethod:y.triggerMethod});var _=function(){function t(){a(this,t),this._items=new Set}return t.prototype.add=function(t){return this._items.add(t),this},t.prototype["delete"]=function(t){return this._items["delete"](t),this},t.prototype.has=function(t){return this._items.has(t)},t.prototype.clear=function(){return this._items.clear(),this},t.prototype.find=function(t,e){e=e||this;for(var i,n=this._items.values();i=n.next();)if(t.call(e,i.value))return i.value;return null},t.prototype.onEach=function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),n=1;e>n;n++)i[n-1]=arguments[n];return this.forEach(function(e){e[t]&&"function"==typeof e[t]&&y.callFunction(e[t],e,i)})},t.prototype.forEach=function(t,e){return this._items.forEach(t,e),this},h(t,{size:{get:function(){return this._items.size}}}),t}(),w=function(){function t(){a(this,t),this._phases=[],this._initialized=!1}return t.prototype.phase=function(t,e,i){"function"==typeof t&&(e=t,t=e.name||"unamed");var n={n:t,fn:e,ctx:i||this};return this._phases.push(n),this.isInitialized&&this._runPhase(n),this},t.prototype.boot=function(t,e){var i=this;if(this.isInitialized)throw new l("already initalized");var n=this._phases;return y.eachAsync(n,function(e){return i._runPhase(e,t)}).then(function(){i._initialized=!0})},t.prototype.reset=function(){return this._initialized=!1,this},t.prototype._runPhase=function(t,e){return y.callAsyncFunction(t.fn,t.ctx,e)},h(t,{isInitialized:{get:function(){return this._initialized}}}),t}(),b=function(t){function e(){a(this,e),null!=t&&t.apply(this,arguments)}return u(e,t),e}(c),E={comply:function(t,e,i){this._cmds=this._cmds||{},this._cmds[t]={fn:e,ctx:i||this}},command:function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),n=1;e>n;n++)i[n-1]=arguments[n];if(this._cmds=this._cmds||{},!this._cmds.hasOwnProperty(t))throw new b("no handler for command: ",t);var r=this._cmds[t],o=r.fn,s=r.ctx;y.callFunction(o,s,i)},stopComplying:function(t,e,i){this._cmds=this._cmds||{},i=i||this,delete this._cmds[t]}},x={reply:function(t,e,i){this._reqs=this._reqs||{},this._reqs[t]={fn:e,ctx:i||this}},request:function(t){if(this._reqs=this._reqs||{},this._reqs.hasOwnProperty(t)){var i=this._reqs[t],n=i.fn,r=i.ctx;(y.isGenerator(n)||y.isGeneratorFunction(n))&&(n=e.wrap(n));var o=n.apply(r,p.call(arguments,1));return o&&y.isPromise(o)?o:o=o instanceof Error?Promise.reject(o):Promise.resolve(o)}return Promise.reject(new b("no handler for request: "+t))},stopReplying:function(t,e,i){this._reqs=this._reqs||{},i=i||this,delete this._reqs[t]}},M=function(t){function e(t){a(this,e),this._name=t}return u(e,t),e.prototype.extendObject=function(t){o.utils.proxy(t,this,["comply","command","stopComplying","reply","request","stopReplying"])},h(e,null,{Commands:{get:function(){return E}},Requests:{get:function(){return x}}}),e}(v);Object.assign(M.prototype,E,x);var O=function(t){function e(i,n,r){a(this,e),Object.assign(this,{options:n,name:i,app:r}),this.options&&this.options.hasOwnProperty("startWithParent")&&(this.startWithParent=this.options.startWithParent),t.call(this)}return u(e,t),e.prototype.addInitializer=function(t,e,i){this.initializer.phase(t,e,i||this)},e.prototype.addFinalizer=function(t,e,i){this.finalizer.phase(t,e,i||this)},e.prototype.start=function(t){var e=this;return this.initializer.isInitialized?Promise.resolve():(this.triggerMethod("before:start",t),this.initializer.boot(t).then(function(t){return e._startSubmodules()}).then(function(){e.triggerMethod("start",t)}))},e.prototype.stop=function(t){var e=this;return this.isRunning?(this.triggerMethod("before:stop",t),this.finalizer.boot(t).then(function(i){return e._stopSubmodules(t)}).then(function(){e.initializer.reset(),e.finalizer.reset(),e.triggerMethod("stop",t)})):Promise.resolve()},e.prototype.module=function(t,i){var n=void 0===arguments[2]?{}:arguments[2];if(null==i)return this.modules[t];if(this.modules.hasOwnProperty(t))throw new Error("Module already defined "+t);var r=i;return"function"!=typeof i&&(r=e.extend(i)),this.modules[t]=new r(t,n,this.app||this),this.modules[t]},e.prototype.removeModule=function(t){var e=this.module(t);e&&e.stop().then(function(){e.destroy()})},e.prototype.removeAllModules=function(){for(var t in this.modules)this.removeModule(t)},e.prototype.destroy=function(){this.removeAllModules(),t.prototype.destroy.call(this)},e.prototype._startSubmodules=function(t){var e=this;return y.eachAsync(Object.keys(this.modules),function(i){var n=e.modules[i];return n.startWithParent?n.start(t):void 0})},e.prototype._stopSubmodules=function(){return y.eachAsync(this.modules,function(t){return t.stop()})},h(e,{startWithParent:{get:function(){return null==this._startWithParent&&(this._startWithParent=!0),this._startWithParent},set:function(t){this._startWithParent=t}},initializer:{get:function(){return this._initializer||(this._initializer=new w),this._initializer}},finalizer:{get:function(){return this._finalizer||(this._finalizer=new w),this._finalizer}},modules:{get:function(){return null==this._modules&&(this._modules=[]),this._modules}},isRunning:{get:function(){return this.initializer.isInitialized&&!this.finalizer.isInitialized}}}),e}(v),C=function(t){function e(){var i=void 0===arguments[0]?{}:arguments[0];a(this,e),this.options=i,this.el=this.getOption("el"),t.call(this)}return u(e,t),e.buildRegion=function(t){return t instanceof e?t:"string"==typeof t?r(t,e):n(t)},e.prototype.show=function(t,e){var i=t!==this.currentView;return this.empty(),i&&(t.once("destroy",this.empty,this),t.once("render",function(){y.triggerMethodOn(t,"show")}),t.render(),y.triggerMethodOn(t,"before:show"),this._attachHtml(t),this.currentView=t),this},e.prototype.destroy=function(){this.empty(),this.stopListening()},e.prototype.empty=function(){if(this.currentView){var t=this.currentView;return t.off("destroy",this.empty,this),this.trigger("before:empty",t),this._destroyView(),this.trigger("empty",t),delete this.currentView,this}},e.prototype._attachHtml=function(t){this.el.innerHtml="",this.el.appendChild(t.el)},e.prototype._destroyView=function(){var t=this.currentView;t.destroy&&"function"==typeof t.destroy&&!t.isDestroyed?t.destroy():t.remove&&"function"==typeof t.remove&&t.remove()},e}(v),R=["addRegions","addRegion","removeRegion","removeRegions"],V=function(t){function e(){a(this,e),this.regions={},t.call(this)}return u(e,t),e.prototype.extendObject=function(t){y.proxy(t,this,R),t.regions=this.regions},e.prototype.unproxyObject=function(t){R.forEach(function(e){t[e]&&delete t[e]})},e.prototype.addRegions=function(t){var e=void 0,i={},n=Object.keys(t);return n.forEach(function(n){e=t[n],i[n]=this.addRegion(n,e)},this),i},e.prototype.addRegion=function(t,e){var i=o.Region.buildRegion(e);return this._setRegion(t,i),i},e.prototype.removeRegion=function(){var t=p.call(arguments);t.forEach(function(t){if(g.call(this.regions,t)){var e=this.regions[t];e.destroy(),this._unsetRegion(t)}},this)},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.removeRegions()},e.prototype.removeRegions=function(){this.removeRegion.apply(this,Object.keys(this.regions))},e.prototype._setRegion=function(t,e){this.regions[t]=e},e.prototype._unsetRegion=function(t){delete this.regions[t]},e}(v),S=/^\s*</,z="undefined"!=typeof Element&&Element.prototype||{},T=z.addEventListener||function(t,e){return this.attachEvent("on"+t,e)},j=z.removeEventListener||function(t,e){return this.detachEvent("on"+t,e)},A=function(t,e){for(var i=0,n=t.length;n>i;i++)if(t[i]===e)return i;return-1},P="focus blur change".split(" "),q=z.matches||z.webkitMatchesSelector||z.mozMatchesSelector||z.msMatchesSelector||z.oMatchesSelector||function(t){var e=(this.parentNode||document).querySelectorAll(t)||[];return!!~A(e,this)},L=t.View,F=function(t){function e(){for(var i=arguments.length,n=Array(i),r=0;i>r;r++)n[r]=arguments[r];a(this,e),this._domEvents=[],t.call.apply(t,[this].concat(n))}return u(e,t),e.prototype.$=function(t){return o.$(t,this.el)},e.prototype._removeElement=function(){this.undelegateEvents(),this.el.parentNode&&this.el.parentNode.removeChild(this.el)},e.prototype._setElement=function(t){if("string"==typeof t)if(S.test(t)){var e=document.createElement("div");e.innerHTML=t,this.el=e.firstChild}else this.el=document.querySelector(t);else this.el=t;this.$el=o.$(this.el)},e.prototype._setAttributes=function(t){for(var e in t)e in this.el?this.el[e]=t[e]:this.el.setAttribute(e,t[e])},e.prototype.delegateEvents=function(t){var e=this;if(!t&&!(t=y.result(this,"events")))return this;this.undelegateEvents();var i=[];for(var n in t){var r=t[n];"function"!=typeof r&&(r=this[t[n]]);var o=n.match(/^(\S+)\s*(.*)$/);o[2]?this.delegate(o[1],o[2],r.bind(this)):i.push([o[1],r.bind(this)])}return i.forEach(function(t){e.delegate(t[0],t[1])}),this},e.prototype.delegate=function(t,e,i){"function"==typeof e&&(i=e,e=null);var n=this.el,r=e?function(t){var r=t.target||t.srcElement;if(!t.delegateTarget)for(;r&&r!=n;r=r.parentNode)q.call(r,e)&&(t.delegateTarget=r,i(t))}:function(t){t.delegateTarget||i(t)},o=~P.indexOf(t);return T.call(this.el,t,r,o),this._domEvents.push({eventName:t,handler:r,listener:i,selector:e}),r},e.prototype.undelegate=function(t,e,i){if("function"==typeof e&&(i=e,e=null),this.el)for(var n=this._domEvents.slice(),r=0,o=n.length;o>r;r++){var s=n[r],h=s.eventName===t&&(i?s.listener===i:!0)&&(e?s.selector===e:!0);h&&(j.call(this.el,s.eventName,s.handler,!1),this._domEvents.splice(A(n,s),1))}return this},e.prototype.undelegateEvents=function(){if(this.el){for(var t=0,e=this._domEvents.length;e>t;t++){var i=this._domEvents[t];j.call(this.el,i.eventName,i.handler,!1)}this._domEvents.length=0}return this},e}(L),D=function(t){function e(i){a(this,e),this.options=i||{},this.isDestroyed=!1,this.listenTo(this,"show",function(){this._isShown=!0}),this.listenTo(this,"render",function(){this._isRendered=!0}),t.call(this,i)}return u(e,t),e.prototype.destroy=function(){if(this.isDestroyed===!0)return this;var t=p.call(arguments);return this.triggerMethod("before:destroy",t),this.isDestroyed=!0,this.triggerMethod("destroy",t),i("view destroy:",this),this.remove(),this},e.prototype.render=function(){var t=this;this.triggerMethod("before:render",this);var e=this.getOption("template");return null!=e?this._renderTemplate(e).then(function(e){t.el.innerHTML=e,t.delegateEvents(),t.triggerMethod("render",t)}):(this.delegateEvents(),this.triggerMethod("render",this)),this},e.prototype.getTemplateData=function(){return this.model&&"function"==typeof this.model.toJSON?this.model.toJSON():{}},e.prototype.delegateEvents=function(e){this.bindUIElements();var i=e||this.events;i=this.normalizeUIKeys(i);var n=this._configureTriggers(),r={};Object.assign(r,i,n),t.prototype.delegateEvents.call(this,r)},e.prototype.undelegateEvents=function(){this.unbindUIElements(),t.prototype.undelegateEvents.call(this)},e.prototype._configureTriggers=function(){if(!this.triggers)return{};var t=this.normalizeUIKeys(y.result(this,"triggers")),e={},i=void 0,n=void 0;for(n in t)i=t[n],e[n]=this._buildViewTrigger(i);return e},e.prototype._buildViewTrigger=function(t){"string"==typeof t&&(t={event:t});var e=Object.assign({preventDefault:!0,stopPropagation:!0},t);return function(t){t&&(t.preventDefault&&e.preventDefault&&t.preventDefault(),t.stopPropagation&&e.stopPropagation&&t.stopPropagation()),this.triggerMethod(e.event,{view:this,model:this.model,collection:this.collection})}},e.prototype.bindUIElements=function(){var t=this,e=this.getOption("ui");e&&(this._ui||(this._ui=e),e=y.result(this,"_ui"),this.ui={},Object.keys(e).forEach(function(i){var n=t.$(e[i]);n&&n.length&&(n instanceof NodeList&&(n=n[0]),t.ui[i]=n)}))},e.prototype.unbindUIElements=function(){},e.prototype._renderTemplate=function(t){var e=this.getOption("getTemplateData").call(this);return"function"==typeof t?y.callAsyncFunction(t,this,e):Promise.resolve(t)},e.prototype.normalizeUIKeys=function(t){var e=/@ui.([a-zA-Z_\-\$#]+)/i,i={},n=void 0,r=void 0,o=void 0,s=void 0,h=void 0;for(n in t)r=t[n],null!==(o=e.exec(n))&&(h=o[1],s=this._ui[h],null!=s&&(n=n.replace(o[0],s))),i[n]=r;return i},h(e,{isShown:{get:function(){return!!this._isShown}},isRendered:{get:function(){return!!this._isRendered}}}),e}(F);Object.assign(D.prototype,{getOption:y.getOption,triggerMethod:y.triggerMethod});var I=function(t){function e(i){a(this,e),this.options=i||{};var n=this.getOption("regions");this._regionManager=new V,y.proxy(this,this._regionManager,["removeRegion","removeRegions"]),this.regions=this._regionManager.regions,this.options=i||{},this.listenTo(this,"render",function(){this.addRegions(n)}),t.call(this,i)}return u(e,t),e.prototype.addRegion=function(t,e){if("string"==typeof e){var i=this.$(e);if(!i.length)throw new Error("element must exists in dom");e=new C({el:i[0]})}this._regionManager.addRegion(t,e)},e.prototype.addRegions=function(t){for(var e in t)this.addRegion(e,t[e])},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._regionManager.destroy()},e}(D),H=function(t){function e(i){a(this,e),this.children=new _,this._isBuffering=!1,y.bindAll(this,["render"]),t.call(this,i),this.sort=!0,this.once("render",this._initCollectionEvents),this.listenTo(this,"before:show",function(){this.children.forEach(function(t){t.isShown||y.triggerMethodOn(t,"before:show")})}),this.listenTo(this,"show",function(){this.children.forEach(function(t){t.isShown||y.triggerMethodOn(t,"show")})})}return u(e,t),e.prototype.render=function(e){return this.destroyChildren(),this._destroyContainer(),this.listenToOnce(this,"render",function(){this._initContainer(),this.collection&&this._renderChildren(this.collection.models),"function"==typeof e&&e()}),t.prototype.render.call(this)},e.prototype.renderCollection=function(){var t=this,e=void 0;this.trigger("before:render:children"),this.collection.models.forEach(function(i,n){e=t._getChildView(i),t._addChildView(e,n)}),this.trigger("render:children")},e.prototype.renderChildView=function(t,e){this.triggerMethod("before:render:child",t),t.render(),this._attachHTML(t,e),this.triggerMethod("render:child",t)},e.prototype.removeChildView=function(t){t&&("function"==typeof t.destroy?t.destroy():"function"==typeof t.remove&&t.remove(),this.stopListening(t),this.children["delete"](t),0===this.children.size&&this.showEmptyView(),this._updateIndexes(t,!1))},e.prototype.startBuffering=function(){this._buffer=document.createDocumentFragment(),this._isBuffering=!0,this._bufferedChildren=[]},e.prototype.stopBuffering=function(){this._isBuffering=!1,this._triggerBeforeShowBufferedChildren(),this._container.appendChild(this._buffer),this._triggerShowBufferedChildren(),delete this._bufferedChildren},e.prototype.showEmptyView=function(){var t=this.getOption("emptyView");if(t&&!this._emptyView){var e=this._emptyView=new t({model:this.model,collection:this.collection});y.triggerMethodOn(e,"before:show"),this._container.appendChild(e.render().el),y.triggerMethodOn(e,"show")}},e.prototype.hideEmptyView=function(){this._emptyView&&("function"==typeof this._emptyView.destroy?this._emptyView.destroy():"function"==typeof this._emptyView.remove&&this._emptyView.remove(),delete this._emptyView,this._container.innerHtml="")},e.prototype._triggerBeforeShowBufferedChildren=function(){this._isShown&&this._bufferedChildren.forEach(function(t){t._isShown||y.triggerMethodOn(t,"before:show")})},e.prototype._triggerShowBufferedChildren=function(){this._isShown&&this._bufferedChildren.forEach(function(t){t._isShown||y.triggerMethodOn(t,"show")})},e.prototype._getChildView=function(t){var e=this.getOption("childView")||o.View,i=this.getOption("childViewOptions")||{};return new e(Object.assign({model:t},i))},e.prototype._attachHTML=function(t,e){this._isBuffering?(this._buffer.appendChild(t.el),this._bufferedChildren.push(t)):(this._isShown&&y.triggerMethodOn(t,"before:show"),this._insertBefore(t,e)||this._insertAfter(t),this._isShown&&y.triggerMethodOn(t,"show"))},e.prototype._renderChildren=function(t){this.destroyChildren(),0!==this.collection.length?(this.hideEmptyView(),this.startBuffering(),this.renderCollection(),this.stopBuffering()):this.showEmptyView()},e.prototype._addChildView=function(t,e){this._updateIndexes(t,!0,e),this.proxyChildViewEvents(t),this.children.add(t),this.hideEmptyView(),this.renderChildView(t,e),this.triggerMethod("add:child",t)},e.prototype.proxyChildViewEvents=function(t){var e=this.getOption("prefix")||"childview";this.listenTo(t,"all",function(){var i=p.call(arguments);i[0]=e+":"+i[0],i.splice(1,0,t),y.callFunction(this.triggerMethod,this,i)})},e.prototype.resortView=function(){var t=this;return this.triggerMethod("before:resort"),this.render(function(){t.triggerMethod("resort")}),this},e.prototype.destroy=function(){return this.triggerMethod("before:destroy:children"),this.destroyChildren(),this.triggerMethod("destroy:children"),t.prototype.destroy.call(this)},e.prototype.destroyChildren=function(){this._container&&(this._container.innerHtml=""),0!==this.children.size&&(this.children.forEach(this.removeChildView,this),this.children.clear())},e.prototype._insertBefore=function(t,e){var i=void 0,n=this.sort&&e<this.children.size-1;return n&&(i=this.children.find(function(t){return t._index===e+1})),i?(this._container.insertBefore(t.el,i.el),!0):!1},e.prototype._insertAfter=function(t){this._container.appendChild(t.el)},e.prototype._destroyContainer=function(){this._container&&delete this._container},e.prototype._initCollectionEvents=function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"remove",this._onCollectionRemove),this.listenTo(this.collection,"reset",this.render),this.sort&&this.listenTo(this.collection,"sort",this._onCollectionSort))},e.prototype._initContainer=function(){var t=this.getOption("childViewContainer");t=t?this.$(t)[0]:this.el,this._container=t},e.prototype._updateIndexes=function(t,e,i){this.sort&&(e?(t._index=i,this.children.forEach(function(e,i){e._index>=t._index&&e._index++})):this.children.forEach(function(e){e._index>=t._index&&e._index--}))},e.prototype._onCollectionAdd=function(t){var e=this._getChildView(t),i=this.collection.models.indexOf(t);this._addChildView(e,i)},e.prototype._onCollectionRemove=function(t){var e=this.children.find(function(e){return e.model===t});this.removeChildView(e)},e.prototype._onCollectionSort=function(){var t=this,e=this.collection.find(function(e,i){var n=t.children.find(function(t){return t.model===e});return!n||n._index!==i});e&&this.resortView()},e}(D),B=function(e){function i(){var t=void 0===arguments[0]?{}:arguments[0];a(this,i),this.options=t;var e=this.getOption("regions");this._regionManager=new V,this._regionManager.extendObject(this),e&&this._regionManager.addRegions(e),this.channels={},this.channel("global").extendObject(this),"function"==typeof this.initialize&&this.initialize.apply(this,arguments)}return u(i,e),i.prototype.channel=function n(t){if(this.channels[t])return this.channels[t];var n=new o.Channel(t);return this.channels[t]=n,n},i.prototype.startHistory=function(e){if(!this.isRunning)throw new Error("app not started");t.history&&(this.trigger("before:history:start",e),t.history.start(e),this.trigger("history:start",e))},i.prototype.stopHistory=function(){return t.history&&(this.trigger("before:history:stop"),t.history.stop(),this.trigger("history:stop")),this},i.prototype.navigate=function(e,i){t.history.navigate(e,i)},i.prototype.currentFragment=function(){return t.history.fragment},i.prototype.destroy=function(){e.prototype.destroy.call(this),this.channels.forEach(function(t){t.destroy()}),delete this.channels,this._regionManager.unproxyObject(this),this._regionManager.destroy(),delete this._regionManager},i}(O);return B.extend=D.extend=H.extend=I.extend=C.extend=V.extend=O.extend=v.extend=t.extend,o.ajax=m(),Object.assign(o,{Application:B,Module:O,RegionManager:V,Region:C,LayoutView:I,View:D,CollectionView:H,Channel:M,List:_,Object:v,utils:y,NativeView:F}),o});