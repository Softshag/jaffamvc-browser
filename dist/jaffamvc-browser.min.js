/*!
 * JaffaMVC.js 0.1.7
 * (c) 2015 Rasmus KildevÃ¦ld, Softshag.
 * Inspired and based on Backbone.Marionette.js
 * (c) 2014 Derick Bailey, Muted Solutions, LLC.
 * (c) 2014 Adam Krebs, Jimmy Yuen Ho Wong
 * JaffaMVC may be freely distributed under the MIT license.
 */
!function(t,e){if("function"==typeof define&&define.amd)define(["backbone","co"],e);else if("object"==typeof exports){var n,i=null,r=null;try{i=require("exoskeleton")}catch(o){try{i=require("backbone")}catch(o){n=o}}try{r=require("co")}catch(o){}if(null===i)throw n;module.exports=e(i,r)}else t.JaffaMVC=e(t.Exoskeleton||t.Backbone,r)}(this,function(t,e){"use strict";function n(){if(o.Debug===!0){var t=["MVC: "].concat(f.call(arguments));return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,t)}}function i(){var t=void 0===arguments[0]?{}:arguments[0];if(!t.selector)throw new Error("No selector specified",t);return r(t.selector,t.regionClass||V)}function r(t,e){var n=o.$(t);if(!n.length)throw new Error("Selector must exists in the dom");return new e({el:n[0]})}var o={};o.version="0.1.7",o.Debug=!1;var s=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t)){for(var n,i=[],r=t[Symbol.iterator]();!(n=r.next()).done&&(i.push(n.value),!e||i.length!==e););return i}throw new TypeError("Invalid attempt to destructure non-iterable instance")},h=function(){function t(t,e){for(var n in e){var i=e[n];i.configurable=!0,i.value&&(i.writable=!0)}Object.defineProperties(t,e)}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),u=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(t.__proto__=e)},a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};Object.assign(o,{Events:t.Events,History:t.History,Model:t.Model,Collection:t.Collection,Router:t.Router});var c=function(t){function e(){a(this,e),null!=t&&t.apply(this,arguments)}return u(e,t),e}(Error),l=function(t){function e(){a(this,e),null!=t&&t.apply(this,arguments)}return u(e,t),e}(c),d=function(t){var e=[],n=void 0,i=document,r=i.documentElement.doScroll,o="DOMContentLoaded",s=(r?/^loaded|^c/:/^loaded|^i|^c/).test(i.readyState);return s||i.addEventListener(o,n=function(){for(i.removeEventListener(o,n),s=1;n=e.shift();)n()}),function(t){s?t():e.push(t)}}();o.$=function(t,e){if("function"==typeof t)return d(t);if(e=e||document,"string"!=typeof t&&"nodeType"in t)return[t];if("string"==typeof e){if(e=document.querySelectorAll(e),!e.length)return e;var n=e,i=s(n,1);e=i[0]}return e.querySelectorAll(t)};var p=function(t){return t.toLowerCase().replace(/-(.)/g,function(t,e){return e.toUpperCase()})},f=Array.prototype.slice,g=Object.prototype.hasOwnProperty,y=Function.prototype.bind,m={callFunction:function(t,e,n){switch(n.length){case 0:return t.call(e);case 1:return t.call(e,n[0]);case 2:return t.call(e,n[0],n[1]);case 3:return t.call(e,n[0],n[1],n[2]);case 4:return t.call(e,n[0],n[1],n[2],n[3]);default:return t.apply(e,n)}},callAsyncFunction:function(t,n,i){return new Promise(function(r,o){var s=void 0,h=void 0;if(s=function(t,e){return t?o(t):void r(e)},t.length>1)return t.call(n,i,s);if(m.isGenerator(t)||m.isGeneratorFunction(t)){if(!e||"function"!=typeof e.wrap)throw new Error("generators support needs co! - see https://github.com/tj/co");t=e.wrap(t)}try{h=t.call(n,i)}catch(u){h=u}h instanceof Error?o(h):h&&m.isPromise(h)?h.then(r,o):r(h)})},eachAsync:function(t,e,n){var i=0,r=t.length;return new Promise(function(o,s){var h=function(t){var e=function(e){return t.apply(this,arguments)};return e.toString=function(){return t.toString()},e}(function(u){return null!=u||i===r?u?s(u):o():void m.callAsyncFunction(e,n,t[i++]).then(function(t){h()},h)});h(null)})},bindAll:function(t,e){return m.proxy(t,t,e)},bind:function(t,e){if(y&&t.bind===y)return y.apply(t,f.call(arguments,1));var n=f.call(arguments,2),i=function(){return t.apply(e,n.concat(f(arguments)))};return i},getOption:function(t){var e=void 0===arguments[1]?{}:arguments[1],n=this.options||{};return e[t]||n[t]||this[t]},triggerMethod:function(t){var e=p("on-"+t.replace(/:/g,"-")),n=m.getOption.call(this,e),i=f.call(arguments,1);m.callFunction(this.trigger,this,f.call(arguments)),"function"==typeof n&&m.callFunction(n,this,i)},triggerMethodOn:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];m.callFunction(m.triggerMethod,t,n)},proxy:function(t,e,n){Array.isArray(n)||(n=[n]),n.forEach(function(n){"function"==typeof e[n]&&(t[n]=m.bind(e[n],e))})},isGenerator:function(t){return"function"==typeof t.next&&"function"==typeof t["throw"]},isGeneratorFunction:function(t){var e=t.constructor;return e?"GeneratorFunction"===e.name||"GeneratorFunction"===e.displayName?!0:m.isGenerator(e.prototype):!1},isPromise:function(t){return"function"==typeof t.then},isObject:function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},result:function(t,e){for(var n=arguments.length,i=Array(n>2?n-2:0),r=2;n>r;r++)i[r-2]=arguments[r];return"function"==typeof t[e]?t[e].apply(t,i):t[e]},assign:Object.assign||function(t){var e,n,i,r=f.call(arguments,1);for(e=0;e<r.length;e++){i=r[e];for(n in i)i.hasOwnProperty(n)&&(t[n]=i[n])}return t},inherits:function(t,e){function n(){this.constructor=t}for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t}},v=function(){var t=function(){var t=void 0;if(null!=window.XMLHttpRequest)return new XMLHttpRequest;try{return new ActiveXObject("msxml2.xmlhttp.6.0")}catch(e){t=e}try{return new ActiveXObject("msxml2.xmlhttp.3.0")}catch(e){t=e}try{return new ActiveXObject("msxml2.xmlhttp")}catch(e){t=e}return t},e=/^(?:application|text)\/xml/,n=/^application\/json/,i=/^file:/,r=function(t,i){return null==t&&(t=i.getResponseHeader("content-type")),e.test(t)?i.responseXML:n.test(t)&&""!==i.responseText?JSON.parse(i.responseText):i.responseText},o=function(t,e){return t.status>=200&&t.status<300||304===t.status||0===t.status&&i.test(e)},s=function(t,e,n,i){return function(){if(4===t.readyState){var s=t.status,h=r(e.headers&&e.headers.Accept,t);if(o(t,e.url))e.success&&e.success(h),n&&n(h);else{var u=new Error("Server responded with a status of "+s);e.error&&e.error(t,s,u),i&&i(t)}}}};return function(e){if(null==e||!m.isObject(e))throw new Error("no opts");e.type=(e.type||"GET").toUpperCase();var n=t();if(n instanceof Error)throw n;var i=void 0,r=void 0,o=new Promise(function(t,e){i=t,r=e});if(null==e.headers&&(e.headers={}),e.headers["X-Requested-With"]="XMLHttpRequest",e.contentType&&(e.headers["Content-Type"]=e.contentType),"GET"===e.type&&"object"==typeof e.data){var h="",u=function(t,e){return null==e?"":"&"+encodeURIComponent(t)+"="+encodeURIComponent(e)};for(var a in e.data)h+=u(a,e.data[a]);if(h){var c=-1===e.url.indexOf("?")?"?":"&";e.url+=c+h.substring(1)}}n.addEventListener("readystatechange",s(n,e,i,r)),"function"==typeof e.progress&&n.addEventListener("progress",e.progress),n.open(e.type,e.url,!0);var l="*/".concat("*"),d={"*":l,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"};if(n.setRequestHeader("Accept",e.dataType&&d[e.dataType]?d[e.dataType]+("*"!==e.dataType?", "+l+"; q=0.01":""):d["*"]),e.headers)for(var p in e.headers)n.setRequestHeader(p,e.headers[p]);return e.beforeSend&&e.beforeSend(n),e.withCredentials&&(n.withCredentials=!0),n.send(e.data),o}},_=function(){function t(){a(this,t),"function"==typeof this.initialize&&m.callFunction(this.initialize,this,arguments)}return t.prototype.destroy=function(){for(var t=arguments.length,e=Array(t),n=0;t>n;n++)e[n]=arguments[n];if(!this.isDestroyed)return this.triggerMethod("before:destroy",e),this._isDestroyed=!0,this.triggerMethod("destroy",e),this.stopListening(),this},h(t,{isDestroyed:{get:function(){return null==this._isDestroyed&&(this._isDestroyed=!1),this._isDestroyed}}}),t}();_.extend=t.extend,Object.assign(_.prototype,t.Events,{getOption:m.getOption,triggerMethod:m.triggerMethod});var w=function(){function t(){a(this,t),this._items=new Set}return t.prototype.add=function(t){return this._items.add(t),this},t.prototype["delete"]=function(t){return this._items["delete"](t),this},t.prototype.has=function(t){return this._items.has(t)},t.prototype.clear=function(){return this._items.clear(),this},t.prototype.find=function(t,e){e=e||this;for(var n,i=this._items.values();n=i.next();)if(t.call(e,n.value))return n.value;return null},t.prototype.onEach=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];return this.forEach(function(e){e[t]&&"function"==typeof e[t]&&m.callFunction(e[t],e,n)})},t.prototype.forEach=function(t,e){return this._items.forEach(t,e),this},h(t,{size:{get:function(){return this._items.size}}}),t}(),b=function(){function t(){a(this,t),this._phases=[],this._initialized=!1}return t.prototype.phase=function(t,e,n){"function"==typeof t&&(e=t,t=e.name||"unamed");var i={n:t,fn:e,ctx:n||this};return this._phases.push(i),this.isInitialized&&this._runPhase(i),this},t.prototype.boot=function(t,e){var n=this;if(this.isInitialized)throw new l("already initalized");var i=this._phases;return m.eachAsync(i,function(e){return n._runPhase(e,t)}).then(function(){n._initialized=!0})},t.prototype.reset=function(){return this._initialized=!1,this},t.prototype._runPhase=function(t,e){return m.callAsyncFunction(t.fn,t.ctx,e)},h(t,{isInitialized:{get:function(){return this._initialized}}}),t}(),E=function(t){function e(){a(this,e),null!=t&&t.apply(this,arguments)}return u(e,t),e}(c),x={comply:function(t,e,n){this._cmds=this._cmds||{},this._cmds[t]={fn:e,ctx:n||this}},command:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];if(this._cmds=this._cmds||{},!this._cmds.hasOwnProperty(t))throw new E("no handler for command: ",t);var r=this._cmds[t],o=r.fn,s=r.ctx;m.callFunction(o,s,n)},stopComplying:function(t,e,n){this._cmds=this._cmds||{},n=n||this,delete this._cmds[t]}},O={reply:function(t,e,n){this._reqs=this._reqs||{},this._reqs[t]={fn:e,ctx:n||this}},request:function(t){if(this._reqs=this._reqs||{},this._reqs.hasOwnProperty(t)){var n=this._reqs[t],i=n.fn,r=n.ctx;(m.isGenerator(i)||m.isGeneratorFunction(i))&&(i=e.wrap(i));var o=i.apply(r,f.call(arguments,1));return o&&m.isPromise(o)?o:o=o instanceof Error?Promise.reject(o):Promise.resolve(o)}return Promise.reject(new E("no handler for request: "+t))},stopReplying:function(t,e,n){this._reqs=this._reqs||{},n=n||this,delete this._reqs[t]}},M=function(t){function e(t){a(this,e),this._name=t}return u(e,t),e.prototype.extendObject=function(t){o.utils.proxy(t,this,["comply","command","stopComplying","reply","request","stopReplying"])},h(e,null,{Commands:{get:function(){return x}},Requests:{get:function(){return O}}}),e}(_);Object.assign(M.prototype,x,O);var C=function(t){function e(n,i,r){a(this,e),Object.assign(this,{options:i,name:n,app:r}),this.options&&this.options.hasOwnProperty("startWithParent")&&(this.startWithParent=this.options.startWithParent),t.call(this)}return u(e,t),e.prototype.addInitializer=function(t,e,n){this.initializer.phase(t,e,n||this)},e.prototype.addFinalizer=function(t,e,n){this.finalizer.phase(t,e,n||this)},e.prototype.start=function(t){var e=this;return n("starting module: "+this.name||"undefined"),this.initializer.isInitialized?Promise.resolve():(this.triggerMethod("before:start",t),this.initializer.boot(t).then(function(t){return n("starting submodules for: "+e.name||"undefined"),e._startSubmodules()}).then(function(){n("started module: "+e.name||"undefined"),e.triggerMethod("start",t)})["catch"](function(t){return e.app.trigger("error",t),Promise.reject(t)}))},e.prototype.stop=function(t){var e=this;return this.isRunning?(n("stopping module: "+this.name),this.triggerMethod("before:stop",t),this.finalizer.boot(t).then(function(i){return n("stopping submodules for "+e.name),e._stopSubmodules(t)}).then(function(){e.initializer.reset(),e.finalizer.reset(),e.stopListening(),n("stopped module:",e.name),e.triggerMethod("stop",t)})["catch"](function(t){return e.app.trigger("error",t),Promise.reject(t)})):Promise.resolve()},e.prototype.module=function(t,i){var r=void 0===arguments[2]?{}:arguments[2];if(null==i)return this.modules[t];if(this.modules.hasOwnProperty(t))throw new Error("Module already defined "+t);var o=i;return"function"!=typeof i&&(o=e.extend(i)),n("defining module ",t,"in",this.name),this.modules[t]=new o(t,r,this.app||this),this.modules[t]},e.prototype.removeModule=function(t){var e=this.module(t);e&&e.stop().then(function(){e.destroy()})},e.prototype.removeAllModules=function(){for(var t in this.modules)this.removeModule(t)},e.prototype.destroy=function(){this.removeAllModules(),t.prototype.destroy.call(this)},e.prototype._startSubmodules=function(t){var e=this;return m.eachAsync(Object.keys(this.modules),function(n){var i=e.modules[n];return i.startWithParent?i.start(t):void 0})},e.prototype._stopSubmodules=function(){return m.eachAsync(this.modules,function(t){return t.stop()})},h(e,{startWithParent:{get:function(){return null==this._startWithParent&&(this._startWithParent=!0),this._startWithParent},set:function(t){this._startWithParent=t}},initializer:{get:function(){return this._initializer||(this._initializer=new b),this._initializer}},finalizer:{get:function(){return this._finalizer||(this._finalizer=new b),this._finalizer}},modules:{get:function(){return null==this._modules&&(this._modules=[]),this._modules}},isRunning:{get:function(){return this.initializer.isInitialized&&!this.finalizer.isInitialized}}}),e}(_),V=function(t){function e(){var n=void 0===arguments[0]?{}:arguments[0];a(this,e),this.options=n,this.el=this.getOption("el"),t.call(this)}return u(e,t),e.buildRegion=function(t){return t instanceof e?t:"string"==typeof t?r(t,e):i(t)},e.prototype.show=function(t,e){var n=t!==this.currentView;return this.empty(),n&&(t.once("destroy",this.empty,this),t.once("render",function(){m.triggerMethodOn(t,"show")}),t.render(),m.triggerMethodOn(t,"before:show"),this._attachHtml(t),this.currentView=t),this},e.prototype.destroy=function(){this.empty(),this.stopListening()},e.prototype.empty=function(){if(this.currentView){var t=this.currentView;return t.off("destroy",this.empty,this),this.trigger("before:empty",t),this._destroyView(),this.trigger("empty",t),delete this.currentView,this}},e.prototype._attachHtml=function(t){this.el.innerHtml="",this.el.appendChild(t.el)},e.prototype._destroyView=function(){var t=this.currentView;t.destroy&&"function"==typeof t.destroy&&!t.isDestroyed?t.destroy():t.remove&&"function"==typeof t.remove&&t.remove()},e}(_),R=["addRegions","addRegion","removeRegion","removeRegions"],S=function(t){function e(){a(this,e),this.regions={},t.call(this)}return u(e,t),e.prototype.extendObject=function(t){m.proxy(t,this,R),t.regions=this.regions},e.prototype.unproxyObject=function(t){R.forEach(function(e){t[e]&&delete t[e]})},e.prototype.addRegions=function(t){var e=void 0,n={},i=Object.keys(t);return i.forEach(function(i){e=t[i],n[i]=this.addRegion(i,e)},this),n},e.prototype.addRegion=function(t,e){var n=o.Region.buildRegion(e);return this._setRegion(t,n),n},e.prototype.removeRegion=function(){var t=f.call(arguments);t.forEach(function(t){if(g.call(this.regions,t)){var e=this.regions[t];e.destroy(),this._unsetRegion(t)}},this)},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.removeRegions()},e.prototype.removeRegions=function(){this.removeRegion.apply(this,Object.keys(this.regions))},e.prototype._setRegion=function(t,e){this.regions[t]=e},e.prototype._unsetRegion=function(t){delete this.regions[t]},e}(_),j=/^\s*</,z="undefined"!=typeof Element&&Element.prototype||{},T=z.addEventListener||function(t,e){return this.attachEvent("on"+t,e)},A=z.removeEventListener||function(t,e){return this.detachEvent("on"+t,e)},P=function(t,e){for(var n=0,i=t.length;i>n;n++)if(t[n]===e)return n;return-1},q="focus blur change".split(" "),L=z.matches||z.webkitMatchesSelector||z.mozMatchesSelector||z.msMatchesSelector||z.oMatchesSelector||function(t){var e=(this.parentNode||document).querySelectorAll(t)||[];return!!~P(e,this)},F=t.View,D=function(t){function e(){for(var n=arguments.length,i=Array(n),r=0;n>r;r++)i[r]=arguments[r];a(this,e),this._domEvents=[],t.call.apply(t,[this].concat(i))}return u(e,t),e.prototype.$=function(t){return o.$(t,this.el)},e.prototype._removeElement=function(){this.undelegateEvents(),this.el.parentNode&&this.el.parentNode.removeChild(this.el)},e.prototype._setElement=function(t){if("string"==typeof t)if(j.test(t)){var e=document.createElement("div");e.innerHTML=t,this.el=e.firstChild}else this.el=document.querySelector(t);else this.el=t;this.$el=o.$(this.el)},e.prototype._setAttributes=function(t){for(var e in t)e in this.el?this.el[e]=t[e]:this.el.setAttribute(e,t[e])},e.prototype.delegateEvents=function(t){var e=this;if(!t&&!(t=m.result(this,"events")))return this;this.undelegateEvents();var n=[];for(var i in t){var r=t[i];"function"!=typeof r&&(r=this[t[i]]);var o=i.match(/^(\S+)\s*(.*)$/);o[2]?this.delegate(o[1],o[2],r.bind(this)):n.push([o[1],r.bind(this)])}return n.forEach(function(t){e.delegate(t[0],t[1])}),this},e.prototype.delegate=function(t,e,n){"function"==typeof e&&(n=e,e=null);var i=this.el,r=e?function(t){var r=t.target||t.srcElement;if(!t.delegateTarget)for(;r&&r!=i;r=r.parentNode)L.call(r,e)&&(t.delegateTarget=r,n(t))}:function(t){t.delegateTarget||n(t)},o=~q.indexOf(t);return T.call(this.el,t,r,o),this._domEvents.push({eventName:t,handler:r,listener:n,selector:e}),r},e.prototype.undelegate=function(t,e,n){if("function"==typeof e&&(n=e,e=null),this.el)for(var i=this._domEvents.slice(),r=0,o=i.length;o>r;r++){var s=i[r],h=s.eventName===t&&(n?s.listener===n:!0)&&(e?s.selector===e:!0);h&&(A.call(this.el,s.eventName,s.handler,!1),this._domEvents.splice(P(i,s),1))}return this},e.prototype.undelegateEvents=function(){if(this.el){for(var t=0,e=this._domEvents.length;e>t;t++){var n=this._domEvents[t];A.call(this.el,n.eventName,n.handler,!1)}this._domEvents.length=0}return this},e}(F),H=function(t){function e(n){a(this,e),this.options=n||{},this.isDestroyed=!1,this.listenTo(this,"show",function(){this._isShown=!0}),this.listenTo(this,"render",function(){this._isRendered=!0}),t.call(this,n)}return u(e,t),e.prototype.destroy=function(){if(this.isDestroyed===!0)return this;var t=f.call(arguments);return this.triggerMethod("before:destroy",t),this.isDestroyed=!0,this.triggerMethod("destroy",t),n("view destroy:",this),this.remove(),this},e.prototype.render=function(){var t=this;this.triggerMethod("before:render",this);var e=this.getOption("template");return null!=e?this._renderTemplate(e).then(function(e){t.el.innerHTML=e,t.delegateEvents(),t.triggerMethod("render",t)}):(this.delegateEvents(),this.triggerMethod("render",this)),this},e.prototype.getTemplateData=function(){return this.model&&"function"==typeof this.model.toJSON?this.model.toJSON():{}},e.prototype.delegateEvents=function(e){this.bindUIElements();var n=e||this.events;n=this.normalizeUIKeys(n);var i=this._configureTriggers(),r={};Object.assign(r,n,i),t.prototype.delegateEvents.call(this,r)},e.prototype.undelegateEvents=function(){this.unbindUIElements(),t.prototype.undelegateEvents.call(this)},e.prototype._configureTriggers=function(){if(!this.triggers)return{};var t=this.normalizeUIKeys(m.result(this,"triggers")),e={},n=void 0,i=void 0;for(i in t)n=t[i],e[i]=this._buildViewTrigger(n);return e},e.prototype._buildViewTrigger=function(t){"string"==typeof t&&(t={event:t});var e=Object.assign({preventDefault:!0,stopPropagation:!0},t);return function(t){t&&(t.preventDefault&&e.preventDefault&&t.preventDefault(),t.stopPropagation&&e.stopPropagation&&t.stopPropagation()),this.triggerMethod(e.event,{view:this,model:this.model,collection:this.collection})}},e.prototype.bindUIElements=function(){var t=this,e=this.getOption("ui");e&&(this._ui||(this._ui=e),e=m.result(this,"_ui"),this.ui={},Object.keys(e).forEach(function(n){var i=t.$(e[n]);i&&i.length&&(i instanceof NodeList&&(i=i[0]),t.ui[n]=i)}))},e.prototype.unbindUIElements=function(){},e.prototype._renderTemplate=function(t){var e=this.getOption("getTemplateData").call(this);return"function"==typeof t?m.callAsyncFunction(t,this,e):Promise.resolve(t)},e.prototype.normalizeUIKeys=function(t){var e=/@ui.([a-zA-Z_\-\$#]+)/i,n={},i=void 0,r=void 0,o=void 0,s=void 0,h=void 0;for(i in t)r=t[i],null!==(o=e.exec(i))&&(h=o[1],s=this._ui[h],null!=s&&(i=i.replace(o[0],s))),n[i]=r;return n},h(e,{isShown:{get:function(){return!!this._isShown}},isRendered:{get:function(){return!!this._isRendered}}}),e}(D);Object.assign(H.prototype,{getOption:m.getOption,triggerMethod:m.triggerMethod});var I=function(t){function e(n){a(this,e),this.options=n||{};var i=this.getOption("regions");this._regionManager=new S,m.proxy(this,this._regionManager,["removeRegion","removeRegions"]),this.regions=this._regionManager.regions,this.options=n||{},this.listenTo(this,"render",function(){this.addRegions(i)}),t.call(this,n)}return u(e,t),e.prototype.addRegion=function(t,e){if("string"==typeof e){var n=this.$(e);if(!n.length)throw new Error("element must exists in dom");e=new V({el:n[0]})}this._regionManager.addRegion(t,e)},e.prototype.addRegions=function(t){for(var e in t)this.addRegion(e,t[e])},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._regionManager.destroy()},e}(H),B=function(t){function e(n){a(this,e),this.children=new w,this._isBuffering=!1,m.bindAll(this,["render"]),t.call(this,n),this.sort=!0,this.once("render",this._initCollectionEvents),this.listenTo(this,"before:show",function(){this.children.forEach(function(t){t.isShown||m.triggerMethodOn(t,"before:show")})}),this.listenTo(this,"show",function(){this.children.forEach(function(t){t.isShown||m.triggerMethodOn(t,"show")})})}return u(e,t),e.prototype.render=function(e){return this.destroyChildren(),this._destroyContainer(),this.listenToOnce(this,"render",function(){this._initContainer(),this.collection&&this._renderChildren(this.collection.models),"function"==typeof e&&e()}),t.prototype.render.call(this)},e.prototype.renderCollection=function(){var t=this,e=void 0;this.trigger("before:render:children"),this.collection.models.forEach(function(n,i){e=t._getChildView(n),t._addChildView(e,i)}),this.trigger("render:children")},e.prototype.renderChildView=function(t,e){this.triggerMethod("before:render:child",t),t.render(),this._attachHTML(t,e),this.triggerMethod("render:child",t)},e.prototype.removeChildView=function(t){t&&("function"==typeof t.destroy?t.destroy():"function"==typeof t.remove&&t.remove(),this.stopListening(t),this.children["delete"](t),0===this.children.size&&this.showEmptyView(),this._updateIndexes(t,!1))},e.prototype.startBuffering=function(){this._buffer=document.createDocumentFragment(),this._isBuffering=!0,this._bufferedChildren=[]},e.prototype.stopBuffering=function(){this._isBuffering=!1,this._triggerBeforeShowBufferedChildren(),this._container.appendChild(this._buffer),this._triggerShowBufferedChildren(),delete this._bufferedChildren},e.prototype.showEmptyView=function(){var t=this.getOption("emptyView");if(t&&!this._emptyView){var e=this._emptyView=new t({model:this.model,collection:this.collection});m.triggerMethodOn(e,"before:show"),this._container.appendChild(e.render().el),m.triggerMethodOn(e,"show")}},e.prototype.hideEmptyView=function(){this._emptyView&&("function"==typeof this._emptyView.destroy?this._emptyView.destroy():"function"==typeof this._emptyView.remove&&this._emptyView.remove(),delete this._emptyView,this._container.innerHtml="")},e.prototype._triggerBeforeShowBufferedChildren=function(){this._isShown&&this._bufferedChildren.forEach(function(t){t._isShown||m.triggerMethodOn(t,"before:show")})},e.prototype._triggerShowBufferedChildren=function(){this._isShown&&this._bufferedChildren.forEach(function(t){t._isShown||m.triggerMethodOn(t,"show")})},e.prototype._getChildView=function(t){var e=this.getOption("childView")||o.View,n=this.getOption("childViewOptions")||{};return new e(Object.assign({model:t},n))},e.prototype._attachHTML=function(t,e){this._isBuffering?(this._buffer.appendChild(t.el),this._bufferedChildren.push(t)):(this._isShown&&m.triggerMethodOn(t,"before:show"),this._insertBefore(t,e)||this._insertAfter(t),this._isShown&&m.triggerMethodOn(t,"show"))},e.prototype._renderChildren=function(t){this.destroyChildren(),0!==this.collection.length?(this.hideEmptyView(),this.startBuffering(),this.renderCollection(),this.stopBuffering()):this.showEmptyView()},e.prototype._addChildView=function(t,e){this._updateIndexes(t,!0,e),this.proxyChildViewEvents(t),this.children.add(t),this.hideEmptyView(),this.renderChildView(t,e),this.triggerMethod("add:child",t)},e.prototype.proxyChildViewEvents=function(t){var e=this.getOption("prefix")||"childview";this.listenTo(t,"all",function(){var n=f.call(arguments);n[0]=e+":"+n[0],n.splice(1,0,t),m.callFunction(this.triggerMethod,this,n)})},e.prototype.resortView=function(){var t=this;return this.triggerMethod("before:resort"),this.render(function(){t.triggerMethod("resort")}),this},e.prototype.destroy=function(){return this.triggerMethod("before:destroy:children"),this.destroyChildren(),this.triggerMethod("destroy:children"),t.prototype.destroy.call(this)},e.prototype.destroyChildren=function(){this._container&&(this._container.innerHtml=""),0!==this.children.size&&(this.children.forEach(this.removeChildView,this),this.children.clear())},e.prototype._insertBefore=function(t,e){var n=void 0,i=this.sort&&e<this.children.size-1;return i&&(n=this.children.find(function(t){return t._index===e+1})),n?(this._container.insertBefore(t.el,n.el),!0):!1},e.prototype._insertAfter=function(t){this._container.appendChild(t.el)},e.prototype._destroyContainer=function(){this._container&&delete this._container},e.prototype._initCollectionEvents=function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"remove",this._onCollectionRemove),this.listenTo(this.collection,"reset",this.render),this.sort&&this.listenTo(this.collection,"sort",this._onCollectionSort))},e.prototype._initContainer=function(){var t=this.getOption("childViewContainer");t=t?this.$(t)[0]:this.el,this._container=t},e.prototype._updateIndexes=function(t,e,n){this.sort&&(e?(t._index=n,this.children.forEach(function(e,n){e._index>=t._index&&e._index++})):this.children.forEach(function(e){e._index>=t._index&&e._index--}))},e.prototype._onCollectionAdd=function(t){var e=this._getChildView(t),n=this.collection.models.indexOf(t);this._addChildView(e,n)},e.prototype._onCollectionRemove=function(t){var e=this.children.find(function(e){return e.model===t});this.removeChildView(e)},e.prototype._onCollectionSort=function(){var t=this,e=this.collection.find(function(e,n){var i=t.children.find(function(t){return t.model===e});return!i||i._index!==n});e&&this.resortView()},e}(H),N=function(e){function n(){var t=void 0===arguments[0]?{}:arguments[0];a(this,n),this.options=t;var e=this.getOption("regions");this._regionManager=new S,this._regionManager.extendObject(this),e&&this._regionManager.addRegions(e),this.channels={},this.channel("global").extendObject(this),"function"==typeof this.initialize&&this.initialize.apply(this,arguments)}return u(n,e),n.prototype.channel=function i(t){if(this.channels[t])return this.channels[t];var i=new o.Channel(t);return this.channels[t]=i,i},n.prototype.startHistory=function(e){if(!this.isRunning)throw new Error("app not started");t.history&&(this.trigger("before:history:start",e),t.history.start(e),this.trigger("history:start",e))},n.prototype.stopHistory=function(){return t.history&&(this.trigger("before:history:stop"),t.history.stop(),this.trigger("history:stop")),this},n.prototype.navigate=function(e,n){t.history.navigate(e,n)},n.prototype.currentFragment=function(){return t.history.fragment},n.prototype.destroy=function(){e.prototype.destroy.call(this),this.channels.forEach(function(t){t.destroy()}),delete this.channels,this._regionManager.unproxyObject(this),this._regionManager.destroy(),this.stopHistory(),delete this._regionManager},n}(C);return N.extend=H.extend=B.extend=I.extend=V.extend=S.extend=C.extend=_.extend=t.extend,o.ajax=v(),m.assign(o,{Application:N,Module:C,RegionManager:S,Region:V,LayoutView:I,View:H,CollectionView:B,Channel:M,List:w,Object:_,utils:m,NativeView:D}),o});